import type { AreaResumen } from "../types/resumen";

export function clean(str: string): string {
  return str
    .normalize("NFD")
    .replace(/\u0300-\u036f/g, "")
    .replace(/\s+/g, " ")
    .toLowerCase()
    .trim();
}

const AREA_PATTERNS: Record<string, string> = {
  // "Voluntarios CDV > Alabanzas >": "Alabanza",
  //   "Voluntarios CDV > Alabanzas > Asistente de equipo": "Asistente de equipo",
  "Voluntarios CDV > Producci√≥n Lince > Atm√≥sfera": "Atm√≥sfera",
  "Voluntarios CDV > CDV LINCE > Velover": "Velover",
  "Voluntarios CDV > CDV LINCE > Equipo Bienvenida": "Bienvenida",
  "Voluntarios CDV > Producci√≥n Lince > C√°maras": "C√°maras & Video",
  "Voluntarios CDV > Contabilidad": "Contabilidad (Modulo dar)",
  "Voluntarios CDV > CDV LINCE > Crecer": "Crecer",
  "Voluntarios CDV > CDV LINCE > Dedicaciones": "Dedicaciones",
  "Voluntarios CDV > Eventos > Desayuno": "Desayuno",
  "Voluntarios CDV > Voluntario ED": "ED",
  "Voluntarios CDV > CDV LINCE > Equipo M√©dico": "Equipo M√©dico",
  //   "Voluntarios CDV > CDV LINCE > Fin de semana inolvidable": "Fin de semana Inolvidable",
  "Voluntarios CDV > Eventos > Registro": "Registro",
  "Voluntarios CDV > CDV LINCE > Hombres CDV": "Hombres CDV",
  "Voluntarios CDV > CDV LINCE > Informes": "Informes",
  //   "Kids > Bebes - Lince": "Kids",
  //   "Kids > Infantes - Lince": "Kids",
  //   "Kids > Primaria - Lince": "Kids",
  "Voluntarios CDV > Kids Voluntarios": "Kids",
  "Voluntarios CDV > Eventos > Log√≠stica": "Log√≠stica",
  "Voluntarios CDV > Producci√≥n Lince > Luces": "Luces",
  "Voluntarios CDV > CDV LINCE > Mantenimiento": "Mantenimiento",
  "Voluntarios CDV > CDV LINCE > Matrimonios": "Matrimonios",
  "Voluntarios CDV > Producci√≥n Lince > Producci√≥n": "Producci√≥n",
  "Voluntarios CDV > CDV LINCE > Recursos": "Recursos",
  "Voluntarios CDV > CDV LINCE > Reps": "Reps",
  "Voluntarios CDV > Eventos > Sala Verde": "Sala Verde",
  "Voluntarios CDV > CDV LINCE > Seguridad": "Seguridad",
  "Voluntarios CDV > CDV LINCE > Servoluci√≥n": "Servoluci√≥n",
  "Voluntarios CDV > Producci√≥n Lince > Sonido": "Sonido",
  "Voluntarios CDV > Producci√≥n Lince > Voluntario": "Staff Pastoral",
  //   "Voluntarios CDV > Equipo ministerial > L√≠der de Servicio": "L√≠der de Servicio",
  "Voluntarios CDV > Equipo ministerial > IDL": "IDL",
  "Voluntarios CDV > Producci√≥n Lince > Visuales": "Visuales",
  "Voluntarios CDV > Comunicaciones > Comms": "Comms",
  "Voluntarios CDV > CDV LINCE > Grupos peque√±os": "Grupos peque√±os",

};

export function parsePdfText(text: string): AreaResumen[] {
  const areaBlocks: Record<string, { total: number; lateCount: number }> = {};
  const timeRegex = /(\d{1,2}):(\d{2})(am|pm)/gi;

  // üîπ Dividir por bloques de horario
  const groupedSections = text.split(/Grouped by Time:\s*Sunday\s*/i);

  for (const section of groupedSections) {
    if (!/^8:00a\b/i.test(section.trimStart())) continue;
    // ‚õî Solo queremos 8:00am

    // üîπ Ahora procesamos solo ese bloque
    const sections = section.split(/(?=(Voluntarios CDV > |Kids > ))/g);

    for (const block of sections) {
      const matchKey = Object.keys(AREA_PATTERNS)
        .sort((a, b) => b.length - a.length)
        .find((pattern) => clean(block).includes(clean(pattern)));

      if (!matchKey) continue;

      const area = AREA_PATTERNS[matchKey];
      if (!areaBlocks[area]) {
        areaBlocks[area] = { total: 0, lateCount: 0 };
      }

      const matches = [...block.matchAll(timeRegex)];

      for (const match of matches) {
        const hour = parseInt(match[1], 10);
        const minute = parseInt(match[2], 10);
        const ampm = match[3].toLowerCase();

        let hour24 = hour % 12;
        if (ampm === "pm") hour24 += 12;

        const arrivalMinutes = hour24 * 60 + minute;
        const isLate = arrivalMinutes > 420; // 7:00am en minutos

        areaBlocks[area].total += 1;
        if (isLate) areaBlocks[area].lateCount += 1;
      }
    }
  }

  return Object.entries(areaBlocks).map(([area, stats]) => ({
    area,
    total: stats.total,
    lateCount: stats.lateCount,
  }));
}

